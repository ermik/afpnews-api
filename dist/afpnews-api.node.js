!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AfpNews=t():e.AfpNews=t()}(global,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=12)}([function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t){e.exports=require("@babel/runtime/helpers/toConsumableArray")},function(e,t){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("@babel/runtime/helpers/classCallCheck")},function(e,t){e.exports=require("@babel/runtime/helpers/createClass")},function(e,t){e.exports=require("@babel/runtime/helpers/typeof")},function(e,t){e.exports=require("form-data")},function(e,t){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,t){e.exports=require("lucene-query-parser")},function(e,t){e.exports=require("btoa")},function(e,t,r){"use strict";r.r(t);var n=r(0),a=r.n(n),s=r(2),i=r.n(s),o=r(5),u=r.n(o),c=r(6),p=r.n(c),f=r(4),h=r(7),l=r.n(h),d=r(8),k=r.n(d),y=r(3),b=r.n(y);function v(e,t){return m.apply(this,arguments)}function m(){return(m=i()(a.a.mark(function e(t,r){var n,s,i,o,u;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params,s=void 0===n?{}:n,i=r.headers,o=void 0===i?{}:i,e.prev=1,e.next=4,b()({method:"get",url:t,params:s,headers:o});case 4:return u=e.sent,e.abrupt("return",u.data);case 8:return e.prev=8,e.t0=e.catch(1),e.abrupt("return",Promise.reject(e.t0));case 11:case"end":return e.stop()}},e,this,[[1,8]])}))).apply(this,arguments)}function x(e){return g.apply(this,arguments)}function g(){return(g=i()(a.a.mark(function e(t){var r,n,s,i,o,u,c,p,f=arguments;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=f.length>1&&void 0!==f[1]?f[1]:{},n=f.length>2?f[2]:void 0,s=n.formData,i=n.headers,e.prev=2,"object"!==l()(s)){e.next=13;break}for(u in o=new k.a,s)o.append(u,s[u]);return"function"==typeof o.getHeaders&&(i=Object.assign({},i,o.getHeaders())),e.next=9,b.a.post(t,o,{headers:i});case 9:return c=e.sent,e.abrupt("return",c.data);case 13:return e.next=15,b.a.post(t,r,{headers:i});case 15:return p=e.sent,e.abrupt("return",p.data);case 17:e.next=22;break;case 19:return e.prev=19,e.t0=e.catch(2),e.abrupt("return",Promise.reject(e.t0));case 22:case"end":return e.stop()}},e,this,[[2,19]])}))).apply(this,arguments)}var T={products:["news","multimedia","photo","infographie","sid","videographie","livereport","sidtv","parismode"],langs:["fr","en","es","de","pt","ar","zh-tw","zh-cn"],urgencies:[1,2,3,4,5],query:"",size:10,dateFrom:"2012-01-01",dateTo:"now",sortField:"published",sortOrder:"desc"},w=r(9),j=r.n(w),_=r(1),O=r.n(_),q=r(10);function P(e){if("string"!=typeof e)throw"The query must be a string";return e.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function z(e){return""===e?[]:function e(t){if("<implicit>"===t.operator)return[{and:O()(e(t.left)).concat(O()(e(t.right)))}];if("AND"===t.operator)return[{and:O()(e(t.left)).concat(O()(e(t.right)))}];if("OR"===t.operator)return[{or:O()(e(t.left)).concat(O()(e(t.right)))}];if(!t.operator){if(t.left)return O()(e(t.left));if("<implicit>"===t.field)return[j()({},"-"===t.prefix?"and":"or",O()(e(Object.assign({},t,{field:"news"}))).concat(O()(e(Object.assign({},t,{field:"slug"}))),O()(e(Object.assign({},t,{field:"city"}))),O()(e(Object.assign({},t,{field:"country"}))),O()(e(Object.assign({},t,{field:"title"}))),O()(e(Object.assign({},t,{field:"caption"}))),O()(e(Object.assign({},t,{field:"creator"}))),O()(e(Object.assign({},t,{field:"headline"}))),O()(e(Object.assign({},t,{field:"entity_person"}))),O()(e(Object.assign({},t,{field:"entity_location"})))))];var r={name:P(t.field)};return"-"===t.prefix?r.exclude=[P(t.term)]:r.in=[P(t.term)],[r]}}(Object(q.parse)(e))}var A=r(11),E=r.n(A);r.d(t,"default",function(){return K});var K=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.apiKey,n=t.clientId,a=t.clientSecret,s=t.baseUrl;u()(this,e),this.apiKey={apiKey:r,clientId:n,clientSecret:a},this.baseUrl=s||"https://api.afp.com",this.resetToken()}return p()(e,[{key:"authenticate",value:function(){var e=i()(a.a.mark(function e(){var t,r,n,s=arguments;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]?s[0]:{},r=t.username,n=t.password,!this.apiKey){e.next=17;break}if(!r||!n){e.next=6;break}return e.abrupt("return",this.requestAuthenticatedToken({username:r,password:n}));case 6:if(null!==this.token){e.next=10;break}throw new Error("You need to authenticate with credentials once");case 10:if(!1!==this.isTokenValid){e.next=14;break}return e.abrupt("return",this.requestRefreshToken());case 14:return e.abrupt("return",Promise.resolve(this.token));case 15:e.next=26;break;case 17:if(!r||!n){e.next=21;break}throw new Error("You need an api key to make authenticated requests");case 21:if(!0!==this.isTokenValid){e.next=25;break}return e.abrupt("return",Promise.resolve(this.token));case 25:return e.abrupt("return",this.requestAnonymousToken());case 26:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"requestAnonymousToken",value:function(){var e=i()(a.a.mark(function e(){var t;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,v(this.authUrl,{params:{grant_type:"anonymous"},json:!0});case 3:return t=e.sent,e.abrupt("return",this.parseToken(t,"anonymous"));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",Promise.reject(e.t0));case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:"requestAuthenticatedToken",value:function(){var e=i()(a.a.mark(function e(t){var r,n,s;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.username,n=t.password,e.prev=1,e.next=4,x(this.authUrl,{},{formData:{username:r,password:n,grant_type:"password"},headers:this.authorizationBasicHeaders,json:!0});case 4:return s=e.sent,e.abrupt("return",this.parseToken(s,"credentials"));case 8:return e.prev=8,e.t0=e.catch(1),e.abrupt("return",Promise.reject(e.t0));case 11:case"end":return e.stop()}},e,this,[[1,8]])}));return function(t){return e.apply(this,arguments)}}()},{key:"requestRefreshToken",value:function(){var e=i()(a.a.mark(function e(){var t;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,x(this.authUrl,{},{formData:{refresh_token:this.token.refreshToken,grant_type:"refresh_token"},headers:this.authorizationBasicHeaders});case 3:return t=e.sent,e.abrupt("return",this.parseToken(t,this.token.authType));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",Promise.reject(e.t0));case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:"parseToken",value:function(e,t){var r=e.access_token,n=e.refresh_token,a=e.expires_in;return this.token={accessToken:r,refreshToken:n,tokenExpires:+new Date+1e3*a,authType:t},this.saveToken(this.token),Promise.resolve(this.token)}},{key:"resetToken",value:function(){delete this._accessToken,delete this._refreshToken,delete this._tokenExpires,delete this._authType}},{key:"saveToken",value:function(){}},{key:"search",value:function(){var e=i()(a.a.mark(function e(t){var r,n,s,i,o,u,c,p,f,h,l,d,k,y,b,v;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object.assign({},this.defaultSearchParams,t),n=r.products,s=r.size,i=r.dateFrom,o=r.dateTo,u=r.urgencies,c=r.query,p=r.langs,f=r.sortField,h=r.sortOrder,e.next=3,this.authenticate();case 3:(l={and:[]}).and=l.and.concat([{name:"lang",in:p},{name:"product",in:n},{name:"urgency",in:u}]),e.prev=5,l.and=l.and.concat(z(c)),e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(5),e.abrupt("return",Promise.reject(new Error("Invalid request")));case 12:return d={maxRows:s,sortField:f,sortOrder:h,dateRange:{from:i,to:o},query:l},e.prev=13,e.next=16,x("".concat(this.apiUrl,"/search"),d,{headers:{Authorization:"Bearer ".concat(this.token.accessToken),"Content-Type":"application/json"}});case 16:return k=e.sent,y=k.response,b=y.docs,v=y.numFound,e.abrupt("return",Promise.resolve({documents:b,count:v}));case 21:return e.prev=21,e.t1=e.catch(13),e.abrupt("return",Promise.reject(e.t1));case 24:case"end":return e.stop()}},e,this,[[5,9],[13,21]])}));return function(t){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=i()(a.a.mark(function e(t){var r,n;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.authenticate();case 2:return e.prev=2,e.next=5,v("".concat(this.apiUrl,"/get/").concat(t),{headers:{Authorization:"Bearer ".concat(this.token.accessToken),"Content-Type":"application/json"}});case 5:return r=e.sent,n=r.response.docs,e.abrupt("return",Promise.resolve({document:n[0]}));case 10:return e.prev=10,e.t0=e.catch(2),e.abrupt("return",Promise.reject(e.t0));case 13:case"end":return e.stop()}},e,this,[[2,10]])}));return function(t){return e.apply(this,arguments)}}()},{key:"authUrl",get:function(){return Object(f.resolve)(this.baseUrl,"/oauth/token")}},{key:"apiUrl",get:function(){return Object(f.resolve)(this.baseUrl,"/v1/api")}},{key:"apiKey",get:function(){return this._apiKey},set:function(e){var t=e.apiKey,r=e.clientId,n=e.clientSecret;r&&n?this._apiKey=E()("".concat(r,":").concat(n)):t?this._apiKey=t:delete this._apiKey}},{key:"isTokenValid",get:function(){return this.token&&this.token.tokenExpires>+new Date}},{key:"token",get:function(){return[this._accessToken,this._tokenExpires,this._refreshToken,this._authType].some(function(e){return void 0===e})?null:{accessToken:this._accessToken,tokenExpires:this._tokenExpires,refreshToken:this._refreshToken,authType:this._authType}},set:function(e){var t=e.accessToken,r=e.refreshToken,n=e.tokenExpires,a=e.authType;this._accessToken=t,this._refreshToken=r,this._tokenExpires=n,this._authType=a}},{key:"authorizationBasicHeaders",get:function(){return{Authorization:"Basic ".concat(this.apiKey)}}},{key:"defaultSearchParams",get:function(){return T}}]),e}()}]).default});