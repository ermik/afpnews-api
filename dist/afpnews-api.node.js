!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AfpNews=t():e.AfpNews=t()}(global,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=11)}([function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("@babel/runtime/helpers/toConsumableArray")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("@babel/runtime/helpers/classCallCheck")},function(e,t){e.exports=require("@babel/runtime/helpers/createClass")},function(e,t){e.exports=require("@babel/runtime/helpers/typeof")},function(e,t){e.exports=require("form-data")},function(e,t){e.exports=require("lucene-query-parser")},function(e,t){e.exports=require("btoa")},function(e,t,r){"use strict";r.r(t);var n=r(0),a=r.n(n),s=r(1),u=r.n(s),o=r(5),i=r.n(o),c=r(6),p=r.n(c),h=r(4),f=r(7),l=r.n(f),d=r(8),k=r.n(d),y=r(3),v=r.n(y);function b(e,t){return m.apply(this,arguments)}function m(){return(m=u()(a.a.mark(function e(t,r){var n,s,u;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params,s=r.headers,e.prev=1,e.next=4,v()({method:"get",url:t,params:n,headers:s});case 4:return u=e.sent,e.abrupt("return",u.data);case 8:return e.prev=8,e.t0=e.catch(1),e.abrupt("return",Promise.reject(e.t0));case 11:case"end":return e.stop()}},e,this,[[1,8]])}))).apply(this,arguments)}function x(e){return T.apply(this,arguments)}function T(){return(T=u()(a.a.mark(function e(t){var r,n,s,u,o,i,c,p,h=arguments;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=h.length>1&&void 0!==h[1]?h[1]:{},n=h.length>2?h[2]:void 0,s=n.formData,u=n.headers,e.prev=2,"object"!==l()(s)){e.next=13;break}for(i in o=new k.a,s)o.append(i,s[i]);return"function"==typeof o.getHeaders&&(u=Object.assign({},u,o.getHeaders())),e.next=9,v.a.post(t,o,{headers:u});case 9:return c=e.sent,e.abrupt("return",c.data);case 13:return e.next=15,v.a.post(t,r,{headers:u});case 15:return p=e.sent,e.abrupt("return",p.data);case 17:e.next=22;break;case 19:return e.prev=19,e.t0=e.catch(2),e.abrupt("return",Promise.reject(e.t0));case 22:case"end":return e.stop()}},e,this,[[2,19]])}))).apply(this,arguments)}var g={products:["news","multimedia","photo","infographie","sid","videographie","livereport","sidtv","parismode"],langs:["fr","en","es","de","pt","ar","zh-tw","zh-cn"],urgencies:[1,2,3,4,5],query:"",size:10,dateFrom:"2012-01-01",dateTo:"now",sortField:"published",sortOrder:"desc"},w=r(2),_=r.n(w),j=r(9);function q(e){if("<implicit>"===e.operator)return _()(q(e.left)).concat(_()(q(e.right)));if("AND"===e.operator)return[{and:_()(q(e.left)).concat(_()(q(e.right)))}];if("OR"===e.operator)return[{or:_()(q(e.left)).concat(_()(q(e.right)))}];if(!e.operator){if(e.left)return _()(q(e.left));var t={name:"<implicit>"===e.field?"news":e.field};return"-"===e.prefix?t.exclude=[e.term]:t.in=[e.term],[t]}}function P(e){return O.apply(this,arguments)}function O(){return(O=u()(a.a.mark(function e(t){var r,n;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t&&""!==t){e.next=3;break}return e.abrupt("return",[]);case 3:return r=Object(j.parse)(t),n=q(r),e.abrupt("return",n);case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",Promise.reject(e.t0));case 11:case"end":return e.stop()}},e,this,[[0,8]])}))).apply(this,arguments)}var E=r(10),K=r.n(E);r.d(t,"default",function(){return A});var A=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.apiKey,n=t.clientId,a=t.clientSecret,s=t.baseUrl;i()(this,e),this.apiKey={apiKey:r,clientId:n,clientSecret:a},this.baseUrl=s||"https://api.afp.com",this.resetToken()}return p()(e,[{key:"authenticate",value:function(){var e=u()(a.a.mark(function e(){var t,r,n,s=arguments;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]?s[0]:{},r=t.username,n=t.password,!this.apiKey){e.next=17;break}if(!r||!n){e.next=6;break}return e.abrupt("return",this.requestAuthenticatedToken({username:r,password:n}));case 6:if(null!==this.token){e.next=10;break}throw new Error("You need to authenticate with credentials once");case 10:if(!1!==this.isTokenValid){e.next=14;break}return e.abrupt("return",this.requestRefreshToken());case 14:return e.abrupt("return",Promise.resolve(this.token));case 15:e.next=22;break;case 17:if(!r||!n){e.next=21;break}throw new Error("You need an api key to make authenticated requests");case 21:return e.abrupt("return",this.requestAnonymousToken());case 22:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"requestAnonymousToken",value:function(){var e=u()(a.a.mark(function e(){var t;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,b(this.authUrl,{params:{grant_type:"anonymous"},json:!0});case 3:return(t=e.sent).authType="anonymous",e.abrupt("return",this.parseToken(t));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",Promise.reject(e.t0));case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(){return e.apply(this,arguments)}}()},{key:"requestAuthenticatedToken",value:function(){var e=u()(a.a.mark(function e(t){var r,n,s;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.username,n=t.password,e.prev=1,e.next=4,x(this.authUrl,{},{formData:{username:r,password:n,grant_type:"password"},headers:this.authorizationBasicHeaders,json:!0});case 4:return(s=e.sent).authType="credentials",e.abrupt("return",this.parseToken(s));case 9:return e.prev=9,e.t0=e.catch(1),e.abrupt("return",Promise.reject(e.t0));case 12:case"end":return e.stop()}},e,this,[[1,9]])}));return function(t){return e.apply(this,arguments)}}()},{key:"requestRefreshToken",value:function(){var e=u()(a.a.mark(function e(){var t;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,x(this.authUrl,{},{formData:{refresh_token:this.token.refreshToken,grant_type:"refresh_token"},headers:this.authorizationBasicHeaders});case 3:return(t=e.sent).authType=this.token.authType,e.abrupt("return",this.parseToken(t));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",Promise.reject(e.t0));case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(){return e.apply(this,arguments)}}()},{key:"parseToken",value:function(e){var t=e.access_token,r=e.refresh_token,n=e.expires_in,a=e.authType;return this.token={accessToken:t,refreshToken:r,tokenExpires:+new Date+1e3*n,authType:a},Promise.resolve(this.token)}},{key:"resetToken",value:function(){delete this._accessToken,delete this._refreshToken,delete this._tokenExpires,delete this._authType}},{key:"search",value:function(){var e=u()(a.a.mark(function e(t){var r,n,s,u,o,i,c,p,h,f,l,d,k,y,v,b,m;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object.assign({},this.defaultSearchParams,t),n=r.products,s=r.size,u=r.dateFrom,o=r.dateTo,i=r.urgencies,c=r.query,p=r.langs,h=r.sortField,f=r.sortOrder,e.next=3,this.authenticate();case 3:return(l={and:[]}).and.push({name:"lang",in:p}),l.and.push({name:"product",in:n}),l.and.push({name:"urgency",in:i}),e.prev=7,e.next=10,this.buildQuery(c);case 10:d=e.sent,l.and=l.and.concat(d),e.next=17;break;case 14:return e.prev=14,e.t0=e.catch(7),e.abrupt("return",Promise.reject(new Error("Invalid request")));case 17:return k={maxRows:s,sortField:h,sortOrder:f,dateRange:{from:u,to:o},query:l},e.prev=18,e.next=21,x(this.searchUrl,k,{headers:{Authorization:"Bearer ".concat(this.token.accessToken),"Content-Type":"application/json"}});case 21:return y=e.sent,v=y.response,b=v.docs,m=v.numFound,e.abrupt("return",Promise.resolve({documents:b||[],count:m}));case 26:return e.prev=26,e.t1=e.catch(18),e.abrupt("return",Promise.reject(e.t1));case 29:case"end":return e.stop()}},e,this,[[7,14],[18,26]])}));return function(t){return e.apply(this,arguments)}}()},{key:"authUrl",get:function(){return Object(h.resolve)(this.baseUrl,"/oauth/token")}},{key:"apiKey",get:function(){return this._apiKey},set:function(e){var t=e.apiKey,r=e.clientId,n=e.clientSecret;r&&n?this._apiKey=K()("".concat(r,":").concat(n)):t?this._apiKey=t:delete this._apiKey}},{key:"isTokenValid",get:function(){return this.token&&this.token.tokenExpires>+new Date}},{key:"token",get:function(){return void 0===this._accessToken||void 0===this._tokenExpires||void 0===!this._refreshToken||void 0===this._authType?null:{accessToken:this._accessToken,tokenExpires:this._tokenExpires,refreshToken:this._refreshToken,authType:this._authType}},set:function(e){var t=e.accessToken,r=e.refreshToken,n=e.tokenExpires,a=e.authType;this._accessToken=t,this._refreshToken=r,this._tokenExpires=n,this._authType=a}},{key:"authorizationBasicHeaders",get:function(){return{Authorization:"Basic ".concat(this.apiKey)}}},{key:"searchUrl",get:function(){return Object(h.resolve)(this.baseUrl,"/v1/api/search")}},{key:"defaultSearchParams",get:function(){return g}},{key:"buildQuery",get:function(){return P}}]),e}()}]).default});